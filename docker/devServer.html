<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DevServer 배포 자동화 | Hoon&#39;s devlog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js" defer="true"></script>
    <meta name="description" content="Hoon&#39;s devlog">
    
    <link rel="preload" href="/Learning-things/assets/css/0.styles.4637925a.css" as="style"><link rel="preload" href="/Learning-things/assets/js/app.2869015d.js" as="script"><link rel="preload" href="/Learning-things/assets/js/29.9734a91e.js" as="script"><link rel="prefetch" href="/Learning-things/assets/js/1.19a2e6c4.js"><link rel="prefetch" href="/Learning-things/assets/js/10.cd7684c0.js"><link rel="prefetch" href="/Learning-things/assets/js/100.945aa850.js"><link rel="prefetch" href="/Learning-things/assets/js/101.9b55f5c5.js"><link rel="prefetch" href="/Learning-things/assets/js/102.b071841a.js"><link rel="prefetch" href="/Learning-things/assets/js/103.a49cfb88.js"><link rel="prefetch" href="/Learning-things/assets/js/104.29d5a66a.js"><link rel="prefetch" href="/Learning-things/assets/js/105.0203e63b.js"><link rel="prefetch" href="/Learning-things/assets/js/106.7df2d09b.js"><link rel="prefetch" href="/Learning-things/assets/js/107.37d22879.js"><link rel="prefetch" href="/Learning-things/assets/js/108.99c1335d.js"><link rel="prefetch" href="/Learning-things/assets/js/109.6712c0ba.js"><link rel="prefetch" href="/Learning-things/assets/js/11.e7566ce9.js"><link rel="prefetch" href="/Learning-things/assets/js/110.eaed1948.js"><link rel="prefetch" href="/Learning-things/assets/js/111.39b76580.js"><link rel="prefetch" href="/Learning-things/assets/js/112.d8a2719f.js"><link rel="prefetch" href="/Learning-things/assets/js/113.b2a0b9c1.js"><link rel="prefetch" href="/Learning-things/assets/js/114.aae883ef.js"><link rel="prefetch" href="/Learning-things/assets/js/115.1515dee7.js"><link rel="prefetch" href="/Learning-things/assets/js/116.78fd5051.js"><link rel="prefetch" href="/Learning-things/assets/js/117.03e3108e.js"><link rel="prefetch" href="/Learning-things/assets/js/118.466a26ef.js"><link rel="prefetch" href="/Learning-things/assets/js/119.10ce92e9.js"><link rel="prefetch" href="/Learning-things/assets/js/12.1a3fa132.js"><link rel="prefetch" href="/Learning-things/assets/js/120.289c110c.js"><link rel="prefetch" href="/Learning-things/assets/js/121.b393089a.js"><link rel="prefetch" href="/Learning-things/assets/js/122.e23cce2f.js"><link rel="prefetch" href="/Learning-things/assets/js/123.55f13093.js"><link rel="prefetch" href="/Learning-things/assets/js/124.fd3748d0.js"><link rel="prefetch" href="/Learning-things/assets/js/125.5bb25b1f.js"><link rel="prefetch" href="/Learning-things/assets/js/126.0737423a.js"><link rel="prefetch" href="/Learning-things/assets/js/127.8f50110f.js"><link rel="prefetch" href="/Learning-things/assets/js/128.e95b2500.js"><link rel="prefetch" href="/Learning-things/assets/js/129.b4280bfc.js"><link rel="prefetch" href="/Learning-things/assets/js/13.bf52c4e9.js"><link rel="prefetch" href="/Learning-things/assets/js/130.20eb3d46.js"><link rel="prefetch" href="/Learning-things/assets/js/131.7c36f79c.js"><link rel="prefetch" href="/Learning-things/assets/js/132.287c4c4f.js"><link rel="prefetch" href="/Learning-things/assets/js/133.8c826eb0.js"><link rel="prefetch" href="/Learning-things/assets/js/134.dc468c6c.js"><link rel="prefetch" href="/Learning-things/assets/js/135.b65e4041.js"><link rel="prefetch" href="/Learning-things/assets/js/136.9d10a06b.js"><link rel="prefetch" href="/Learning-things/assets/js/137.5cfce332.js"><link rel="prefetch" href="/Learning-things/assets/js/138.c38c72f3.js"><link rel="prefetch" href="/Learning-things/assets/js/139.a5f9f7d9.js"><link rel="prefetch" href="/Learning-things/assets/js/14.bf6e1f96.js"><link rel="prefetch" href="/Learning-things/assets/js/140.8057d8c2.js"><link rel="prefetch" href="/Learning-things/assets/js/141.32a203fe.js"><link rel="prefetch" href="/Learning-things/assets/js/142.e1962baf.js"><link rel="prefetch" href="/Learning-things/assets/js/143.ce252a61.js"><link rel="prefetch" href="/Learning-things/assets/js/144.955ebd5a.js"><link rel="prefetch" href="/Learning-things/assets/js/145.c1243761.js"><link rel="prefetch" href="/Learning-things/assets/js/146.be2b1d12.js"><link rel="prefetch" href="/Learning-things/assets/js/147.2fd6dc7d.js"><link rel="prefetch" href="/Learning-things/assets/js/148.95f5b890.js"><link rel="prefetch" href="/Learning-things/assets/js/149.ebe77e77.js"><link rel="prefetch" href="/Learning-things/assets/js/15.fd0e76d2.js"><link rel="prefetch" href="/Learning-things/assets/js/150.b6552935.js"><link rel="prefetch" href="/Learning-things/assets/js/151.70bb8317.js"><link rel="prefetch" href="/Learning-things/assets/js/152.258782bb.js"><link rel="prefetch" href="/Learning-things/assets/js/153.f218789f.js"><link rel="prefetch" href="/Learning-things/assets/js/154.c254f48b.js"><link rel="prefetch" href="/Learning-things/assets/js/155.3bc7aeda.js"><link rel="prefetch" href="/Learning-things/assets/js/156.3641771b.js"><link rel="prefetch" href="/Learning-things/assets/js/157.e0e180e7.js"><link rel="prefetch" href="/Learning-things/assets/js/158.a42ae42b.js"><link rel="prefetch" href="/Learning-things/assets/js/16.87932dd1.js"><link rel="prefetch" href="/Learning-things/assets/js/17.78a4f6ef.js"><link rel="prefetch" href="/Learning-things/assets/js/18.0019d2d3.js"><link rel="prefetch" href="/Learning-things/assets/js/19.3bd56e11.js"><link rel="prefetch" href="/Learning-things/assets/js/2.324b0587.js"><link rel="prefetch" href="/Learning-things/assets/js/20.ae9ac2db.js"><link rel="prefetch" href="/Learning-things/assets/js/21.d6b5dcdc.js"><link rel="prefetch" href="/Learning-things/assets/js/22.8f120231.js"><link rel="prefetch" href="/Learning-things/assets/js/23.dac54d6d.js"><link rel="prefetch" href="/Learning-things/assets/js/24.8653b185.js"><link rel="prefetch" href="/Learning-things/assets/js/25.7e7044a9.js"><link rel="prefetch" href="/Learning-things/assets/js/26.9a1dfe9a.js"><link rel="prefetch" href="/Learning-things/assets/js/27.9b90ca6d.js"><link rel="prefetch" href="/Learning-things/assets/js/28.5ce8ecac.js"><link rel="prefetch" href="/Learning-things/assets/js/3.4f744869.js"><link rel="prefetch" href="/Learning-things/assets/js/30.912a1777.js"><link rel="prefetch" href="/Learning-things/assets/js/31.16574eb0.js"><link rel="prefetch" href="/Learning-things/assets/js/32.1389fb47.js"><link rel="prefetch" href="/Learning-things/assets/js/33.497c114e.js"><link rel="prefetch" href="/Learning-things/assets/js/34.bda1af4d.js"><link rel="prefetch" href="/Learning-things/assets/js/35.fd1b1e94.js"><link rel="prefetch" href="/Learning-things/assets/js/36.7d308e79.js"><link rel="prefetch" href="/Learning-things/assets/js/37.0b157bbe.js"><link rel="prefetch" href="/Learning-things/assets/js/38.2c1f2ac4.js"><link rel="prefetch" href="/Learning-things/assets/js/39.9c16b4a4.js"><link rel="prefetch" href="/Learning-things/assets/js/4.6e85e8dd.js"><link rel="prefetch" href="/Learning-things/assets/js/40.426b426a.js"><link rel="prefetch" href="/Learning-things/assets/js/41.c791a6f6.js"><link rel="prefetch" href="/Learning-things/assets/js/42.002cfeaf.js"><link rel="prefetch" href="/Learning-things/assets/js/43.20de3ad9.js"><link rel="prefetch" href="/Learning-things/assets/js/44.991d1e77.js"><link rel="prefetch" href="/Learning-things/assets/js/45.3a02dd8b.js"><link rel="prefetch" href="/Learning-things/assets/js/46.2516ed46.js"><link rel="prefetch" href="/Learning-things/assets/js/47.e2c68ed2.js"><link rel="prefetch" href="/Learning-things/assets/js/48.9e424fe5.js"><link rel="prefetch" href="/Learning-things/assets/js/49.fdeeb719.js"><link rel="prefetch" href="/Learning-things/assets/js/50.aa538c68.js"><link rel="prefetch" href="/Learning-things/assets/js/51.00ffd6fd.js"><link rel="prefetch" href="/Learning-things/assets/js/52.bd1a4449.js"><link rel="prefetch" href="/Learning-things/assets/js/53.97dea2f9.js"><link rel="prefetch" href="/Learning-things/assets/js/54.aa465b8f.js"><link rel="prefetch" href="/Learning-things/assets/js/55.3f967291.js"><link rel="prefetch" href="/Learning-things/assets/js/56.dc745f64.js"><link rel="prefetch" href="/Learning-things/assets/js/57.98d960fd.js"><link rel="prefetch" href="/Learning-things/assets/js/58.97ed959a.js"><link rel="prefetch" href="/Learning-things/assets/js/59.9792d069.js"><link rel="prefetch" href="/Learning-things/assets/js/60.04e44c1d.js"><link rel="prefetch" href="/Learning-things/assets/js/61.2b7dcf5f.js"><link rel="prefetch" href="/Learning-things/assets/js/62.f60a4499.js"><link rel="prefetch" href="/Learning-things/assets/js/63.64d55acc.js"><link rel="prefetch" href="/Learning-things/assets/js/64.086c5ceb.js"><link rel="prefetch" href="/Learning-things/assets/js/65.6eeaaa05.js"><link rel="prefetch" href="/Learning-things/assets/js/66.4fa83eb5.js"><link rel="prefetch" href="/Learning-things/assets/js/67.ac014d34.js"><link rel="prefetch" href="/Learning-things/assets/js/68.2f45215a.js"><link rel="prefetch" href="/Learning-things/assets/js/69.58caa2e0.js"><link rel="prefetch" href="/Learning-things/assets/js/7.bfaf26d5.js"><link rel="prefetch" href="/Learning-things/assets/js/70.fd7d84c0.js"><link rel="prefetch" href="/Learning-things/assets/js/71.22155daa.js"><link rel="prefetch" href="/Learning-things/assets/js/72.7debb9c4.js"><link rel="prefetch" href="/Learning-things/assets/js/73.44e822a8.js"><link rel="prefetch" href="/Learning-things/assets/js/74.ddf404c4.js"><link rel="prefetch" href="/Learning-things/assets/js/75.f905eecf.js"><link rel="prefetch" href="/Learning-things/assets/js/76.21b3623a.js"><link rel="prefetch" href="/Learning-things/assets/js/77.f9bbf054.js"><link rel="prefetch" href="/Learning-things/assets/js/78.f6dd1770.js"><link rel="prefetch" href="/Learning-things/assets/js/79.8a95587b.js"><link rel="prefetch" href="/Learning-things/assets/js/8.2ba230bd.js"><link rel="prefetch" href="/Learning-things/assets/js/80.893250ab.js"><link rel="prefetch" href="/Learning-things/assets/js/81.13724b56.js"><link rel="prefetch" href="/Learning-things/assets/js/82.ac0cd5a5.js"><link rel="prefetch" href="/Learning-things/assets/js/83.7d2253df.js"><link rel="prefetch" href="/Learning-things/assets/js/84.144e2cc4.js"><link rel="prefetch" href="/Learning-things/assets/js/85.a6f045be.js"><link rel="prefetch" href="/Learning-things/assets/js/86.59891d83.js"><link rel="prefetch" href="/Learning-things/assets/js/87.1737e4cd.js"><link rel="prefetch" href="/Learning-things/assets/js/88.e3c66ae9.js"><link rel="prefetch" href="/Learning-things/assets/js/89.b55a50b8.js"><link rel="prefetch" href="/Learning-things/assets/js/9.70739e7b.js"><link rel="prefetch" href="/Learning-things/assets/js/90.941e1d56.js"><link rel="prefetch" href="/Learning-things/assets/js/91.2e05823e.js"><link rel="prefetch" href="/Learning-things/assets/js/92.41236ffd.js"><link rel="prefetch" href="/Learning-things/assets/js/93.ad182f58.js"><link rel="prefetch" href="/Learning-things/assets/js/94.5106adc3.js"><link rel="prefetch" href="/Learning-things/assets/js/95.0bdbb4b9.js"><link rel="prefetch" href="/Learning-things/assets/js/96.299654bf.js"><link rel="prefetch" href="/Learning-things/assets/js/97.6833bc3b.js"><link rel="prefetch" href="/Learning-things/assets/js/98.903ab445.js"><link rel="prefetch" href="/Learning-things/assets/js/99.61a6e47d.js"><link rel="prefetch" href="/Learning-things/assets/js/vendors~docsearch.717a6492.js">
    <link rel="stylesheet" href="/Learning-things/assets/css/0.styles.4637925a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Learning-things/" class="home-link router-link-active"><img src="logo_hoon's_full.png" alt="Hoon's devlog" class="logo"> <span class="site-name can-hide">Hoon's devlog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/jeonghun-project/Learning-things" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/jeonghun-project/Learning-things" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AIboostclass</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AWS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DATABASE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ERC20</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ErrorCase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ShellScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TIL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>algorism</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>docker</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Learning-things/docker/devServer.html" aria-current="page" class="active sidebar-link">DevServer 배포 자동화</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Learning-things/docker/devServer.html#docker로-서버-코드-말아보기" class="sidebar-link">Docker로 서버 코드 말아보기</a></li><li class="sidebar-sub-header"><a href="/Learning-things/docker/devServer.html#docker-github-action으로-배포하기" class="sidebar-link">Docker Github Action으로 배포하기</a></li><li class="sidebar-sub-header"><a href="/Learning-things/docker/devServer.html#docker-compose" class="sidebar-link">Docker-compose</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>go</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>graphql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>kubernetes</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nest</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>output</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>php</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>project</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>shopify</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>solana</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>swagger</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>typescript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue.js</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="devserver-배포-자동화"><a href="#devserver-배포-자동화" class="header-anchor">#</a> DevServer 배포 자동화</h1> <p>우선 Dev서버의 필요성을 느끼고 <em>Dev서버</em>를 구성하기로 하였다.</p> <p>기본적인 <strong>요구조건</strong>은 다음과 같다</p> <ul><li><strong>Production 환경과 같은 환경</strong>에서 운영될 것</li> <li><strong>Mock Server</strong>로서 활용할 수 있을 것</li> <li><strong>CI/CD</strong>에 의하여 소스코드메니저에 의한 자동 배포가 이루어 질 것</li> <li>Dev Server를 <strong>로컬 환경에서도 실행</strong> 할 수 있도록 Docker hub에 구성할 것</li></ul> <p>이렇게 4가지의 과제를 해결하기 위하여 여러가지 방법을 생각해고 시도해본 <strong>시행착오를</strong> 적어보도록 하겠다</p> <h2 id="docker로-서버-코드-말아보기"><a href="#docker로-서버-코드-말아보기" class="header-anchor">#</a> Docker로 서버 코드 말아보기</h2> <p>우선은 모든것의 시작은 도커를 이용하여 <code>Node</code>서버를 구성하여 올려 보도록 하자
<code>docker</code>는 우선 <code>images</code>를 만들어 해당 이미지를 <code>Container</code>로 띄워서 가상 머신을 별다른 세팅없이 가상머신을 돌릴수 있도록 돕는 오픈소스 라이브러리 이다.</p> <p>도커를 설치하는 것은 <a href="https://docs.docker.com/engine/install/" target="_blank" rel="noopener noreferrer">공식 홈페이지를 참조<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>하도록 하자.
*공홈에서 GitHub Action과 함께 사용하는 <a href="https://youtu.be/iqqDU2crIEQ" target="_blank" rel="noopener noreferrer">가이드 영상<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>을 제공해준다</p> <p>도커 설치가 끝났으면이제 구성된 서버를 이미지화 해보자.</p> <ol><li><strong>Create <code>Dockerfile</code></strong></li></ol> <p>Docker는 <code>Dockerfile</code>에 의하여 이미지를 구성한다.</p> <blockquote><p><em>Dockerfile</em>에 대한 자세한 내용은 공식 홈페이지를 참조하자. https://docs.docker.com/engine/reference/builder/</p></blockquote> <p>참고로 본 포스팅에서 구성한 서버는 <code>nestjs</code>. 즉, <code>node</code>환경을 기반으로 구성되어 있다.</p> <p>node용 도커파일의 <a href="https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md" target="_blank" rel="noopener noreferrer">best practice<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>를 <code>node-docker</code>에서 제공하고 있으니 참고해서 작성하면 되겠다.</p> <p>자신의 프로젝트에 맞게끔 <code>Dockerfile</code>을 작성하자.</p> <div class="language- extra-class"><pre class="language-text"><code># Dockerfile
FROM node:16-alpine As development

WORKDIR /home/node/app

COPY package*.json ./

RUN npm install

COPY . /home/node/app

RUN npm run build

FROM node:16 as production

ARG NODE_ENV=production
ENV NODE_ENV=${NODE_ENV}

WORKDIR /

COPY package*.json ./

RUN npm install --production

COPY --from=development /home/node/app/dist /dist

EXPOSE 4000

CMD [ &quot;node&quot;, &quot;/dist/main.js&quot;] 
</code></pre></div><ol><li><strong>Docker build</strong></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ Docker build <span class="token parameter variable">-t</span> images-tag <span class="token builtin class-name">.</span>

<span class="token function">docker</span> build <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token environment constant">PATH</span> <span class="token comment"># 여기서의 PATH는 Dokerfil의 위치를 지정해 주는 것이다.</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">16</span>.6s <span class="token punctuation">(</span><span class="token number">17</span>/17<span class="token punctuation">)</span> FINISHED                                                            
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build definition from Dockerfile                                      <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring dockerfile: 410B                                                      <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load .dockerignore                                                         <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring context: 34B                                                          <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load metadata <span class="token keyword">for</span> docker.io/library/node:16                                <span class="token number">2</span>.4s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load metadata <span class="token keyword">for</span> docker.io/library/node:16-alpine                         <span class="token number">2</span>.4s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>auth<span class="token punctuation">]</span> library/node:pull token <span class="token keyword">for</span> registry-1.docker.io                               <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>production <span class="token number">1</span>/5<span class="token punctuation">]</span> FROM docker.io/library/node:16@sha256:683b8ea4ebc033a0f9060501fc31c  <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>development <span class="token number">1</span>/6<span class="token punctuation">]</span> FROM docker.io/library/node:16-alpine@sha256:8f1827381eb7fca5a79ad  <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build context                                                         <span class="token number">0</span>.1s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring context: <span class="token number">30</span>.90kB                                                      <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>development <span class="token number">2</span>/6<span class="token punctuation">]</span> WORKDIR /home/node/app                                       <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>development <span class="token number">3</span>/6<span class="token punctuation">]</span> COPY package*.json ./                                        <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>development <span class="token number">4</span>/6<span class="token punctuation">]</span> RUN <span class="token function">npm</span> <span class="token function">install</span>                                              <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>development <span class="token number">5</span>/6<span class="token punctuation">]</span> COPY <span class="token builtin class-name">.</span> /home/node/app                                               <span class="token number">0</span>.1s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>development <span class="token number">6</span>/6<span class="token punctuation">]</span> RUN <span class="token function">npm</span> run build                                                  <span class="token number">13</span>.4s
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>production <span class="token number">2</span>/5<span class="token punctuation">]</span> COPY package*.json ./                                         <span class="token number">0</span>.0s 
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>production <span class="token number">3</span>/5<span class="token punctuation">]</span> RUN <span class="token function">npm</span> <span class="token function">install</span>                                               <span class="token number">0</span>.0s 
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>production <span class="token number">4</span>/5<span class="token punctuation">]</span> COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>development /home/node/app/dist /dist             <span class="token number">0</span>.0s 
 <span class="token operator">=</span><span class="token operator">&gt;</span> exporting to image                                                                    <span class="token number">0</span>.0s 
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> exporting layers                                                                   <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> writing image sha256:1ab4c88fc43519a071a1e1b3b3d4c26bd77c53eb17f675102904451f05d7  <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> naming to docker.io/library/images-tag:test                                         <span class="token number">0</span>.0s
</code></pre></div><p>Dockerfile이 실행되면서 Docker imge를 생성하는 과정을 로그로 확인할 수 있다.</p> <ol start="3"><li><strong>Container 띄우기</strong></li></ol> <p>이제 만들어진 이미지를 확인하고 컨테이너로 띄워보자.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> images

REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
images-tag   latest    0ba9d8d1a439   <span class="token number">24</span> minutes ago   984MB
</code></pre></div><p>build된 이미지 repo list를 확인할 수 있다.</p> <p><code>Container</code>는 이러한 이미지를 <code>Docker run</code> 명령을 통해 실행 시키는 것으로 Container를 실행시킬 수 있다.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">4000</span>:4000 <span class="token parameter variable">--rm</span> <span class="token parameter variable">--name</span> <span class="token operator">&lt;</span>Container_name<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>image:tag or image ID<span class="token operator">&gt;</span>
</code></pre></div><p>위의 자세한 Option은 <code>docker run --help</code>를 통해알아보자.</p> <p>하지만 위의 옵션은 Container를 실행해보고 테스트하기에 적절하니 기억해두면 좋다.</p> <ul><li><code>-p</code>: <code>&lt;Container port&gt;:&lt;Host port&gt;</code>가 되겠다. 즉 앞의 포트는 도커가 열리는 포트, 뒤에 포트는 내가 작성한 코드에서 여는 포트가 되겠다.</li> <li><code>-d</code>: detach. 백그라운드에서 실행시킨다.</li> <li><code>--rm</code>: Container <strong>종료와 동시에 삭제한다</strong> 이게 생각보다 유용하다.</li> <li><code>--name</code>: 이름을 정해준다. 안정하면 이름이 임의로 생성된다.</li></ul> <p>이렇게 Container를 실행하면 <code>docker ps</code>를 통해 <strong>실행중인</strong> Container를 조회할 수 있다.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> <span class="token function">ps</span>

CONTAINER ID   IMAGE               COMMAND                  CREATED          STATUS          PORTS      NAMES
b2b3638cb8c6   images-tag:latest   <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">26</span> seconds ago   Up <span class="token number">25</span> seconds   <span class="token number">4000</span>/tcp   test_container
</code></pre></div><p>그다음에 열어둔 포트를 <code>http://localhost:4000</code>아와 같이 접속하면 페이지를 잘 확인할 수 있어야한다.</p> <p><img src="/Learning-things/assets/img/docker.5dcbb4c1.png" alt="example"></p> <p>처음으로 올린 <strong>Docker Container</strong>가 완성되었다.</p> <ol start="4"><li><strong>Docker hub 이용해서 image 공유하기</strong></li></ol> <blockquote><p>이 부분은 Docker hub에 대한 이해를 돕는 부분이다.</p></blockquote> <p><strong>Docker hub계정이 있고 이미 사용경험이 있다면 과감히 건너뛰는 것을 권장한다.</strong></p> <ul><li><p>우선 Docker hub를 이용하기 위해 <em>Docker hub 계정을 만들고 로그인해보자</em></p> <p>그럼 아래와 유사한 화면(<s>이미 저는 테스트해본 Repo가 있는 상태입니다</s>)</p> <p><img src="/Learning-things/assets/img/dockekHub.0625bc69.png" alt="example2"></p></li> <li><p>이렇게 자신의 <strong>docker hub</strong>에 잘 들어가 졌다면이제 image를 Push 해보자</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> push <span class="token operator">&lt;</span>Username<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>image<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>image-tag<span class="token operator">&gt;</span>
</code></pre></div><p>하지만 이렇게 해보면 이미지를 찾을 수 없다고 한다...</p> <p>Push 할때 <strong>Username까지 포함한 image를 local에 생성한 뒤</strong>에 Push해야 하기 때문이다.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> tag <span class="token operator">&lt;</span>image<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>image-tag<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>Username<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>image<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>image-tag<span class="token operator">&gt;</span>
</code></pre></div><p>이다음에 푸시를 위에 실행했던 Push를 실행해보면 잘 수행되는 것을 볼 수 있다.</p> <p>이렇게 <code>image</code>를 밀어넣어주면 <strong>Docker hub에 저처럼 리스트가 생성</strong>됐을 겁니다.</p></li> <li><p>이제 어디서든 <strong>docker hub에서 image를 pull 받아와서 실행할</strong> 수 있다.</p> <p>그 전에 우선 local에 생성한 image를 삭제하고 당겨와서 테스트를 해보자</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> images

REPOSITORY            TAG       IMAGE ID       CREATED          SIZE
images-tag            latest    0ba9d8d1a439   <span class="token number">24</span> minutes ago   984MB
Username/images-tag   latest    41dd421a452f   <span class="token number">4</span> minutes ago    984MB
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> rmi <span class="token operator">&lt;</span>Username<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>image<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>image-tag<span class="token operator">&gt;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> images

REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
images-tag   latest    0ba9d8d1a439   <span class="token number">24</span> minutes ago   984MB
</code></pre></div><p>깔끔히 삭제가 이루어졌다면 이제 Pull을 당겨와서 Container를 실행시켜보자</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">docker</span> pull <span class="token operator">&lt;</span>Username<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>image<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>image-tag<span class="token operator">&gt;</span>

$ <span class="token function">docker</span> images

REPOSITORY            TAG       IMAGE ID       CREATED          SIZE
images-tag            latest    0ba9d8d1a439   <span class="token number">24</span> minutes ago   984MB
Username/images-tag   latest    41dd421a452f   <span class="token number">1</span> minutes ago    984MB
</code></pre></div><p>이렇게 당겨온 image를 run을 통해 실행하면 local에서 만들었던 Container와 똑같이 동작하는 것을 볼 수 있다.</p></li></ul> <h2 id="docker-github-action으로-배포하기"><a href="#docker-github-action으로-배포하기" class="header-anchor">#</a> Docker Github Action으로 배포하기</h2> <p>이제 <code>Docker</code>와 <code>Docker hub</code>에 대하여 알아보았으니 이를 CI/CD를 입혀보자.</p> <ul><li>CircleCI</li> <li>gitlab</li> <li>bamboo</li> <li>github</li> <li>etc</li></ul> <p>다양한 CI/CD 서비스에서 docker hub에 이미지를 올려 배포할 수 있으나</p> <p>본 포스팅에서는 <strong><code>Github action</code>을</strong> 이용하도록 하겠다.</p> <blockquote><p>Git Action은 크게 2단계로 나누어 구성하도록 하였다
1단계는 Pull Request때 테스트 자동화를 위한 Codecov를 이용한 testReport와
docker hub에 버전을 만들어 자동으로 push를 진행하고
2단계는 Push(merge)때 만들어진 latest 버전의 도커 Image를 배포하도록 구성하는 방법을 알아보자</p></blockquote> <ol><li><strong>Git Action을 통한 test 자동화와 Docker hub 구성하기</strong></li></ol> <p>우선 Git Action으로 가서 <code>New workflow</code>를 통해 새로운 일거리(job)을 만들어주자</p> <p><img src="/Learning-things/assets/img/gitaction.e68b4926.png" alt="gitaction"></p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># This is a basic workflow to help you get started with Actions</span>

<span class="token key atrule">name</span><span class="token punctuation">:</span> CI to Docker hub

<span class="token comment"># Controls when the workflow will run</span>
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token comment"># PR이 들어오면 실행된다.</span>
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>master<span class="token punctuation">]</span>

<span class="token comment"># 소일거리를 주자</span>
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">test</span><span class="token punctuation">:</span>
    <span class="token comment"># 운영체제를 선택한다.</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token comment">#현재 PR이 되는 Branch로 체크아웃한다.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check Out Repo
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token comment">#node를 설치한다</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'16'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install node package
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm install
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run test
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm run test

      <span class="token comment"># codecov를 action에서 실행해서 report를 남기도록 한다.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Codecov
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> codecov/codecov<span class="token punctuation">-</span>action@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">token</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.CODECOV_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">flags</span><span class="token punctuation">:</span> unittests

  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check Out Repo
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token comment"># docker hub에 접근할 수 있는 토큰을 이용하여 Docker hub에 접근한다.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Login to Docker Hub
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_ACCESS_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token comment"># 요부분은 Docker에서 지원하는 Plugin을 살펴보자</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx
        <span class="token key atrule">id</span><span class="token punctuation">:</span> buildx
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and push
        <span class="token key atrule">id</span><span class="token punctuation">:</span> docker_build
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">context</span><span class="token punctuation">:</span> ./
          <span class="token key atrule">file</span><span class="token punctuation">:</span> ./Dockerfile
          <span class="token key atrule">push</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token comment">#docker hub에 Username과 event number를 통해서 버전관리를 해주자.</span>
          <span class="token key atrule">tags</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>/images<span class="token punctuation">-</span>tag<span class="token punctuation">:</span>$<span class="token punctuation">{</span><span class="token punctuation">{</span> github.event.number <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>$<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>/images<span class="token punctuation">-</span>tag<span class="token punctuation">:</span>latest

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Image digest
        <span class="token key atrule">run</span><span class="token punctuation">:</span> echo $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.docker_build.outputs.digest <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>*대부분 주석으로 설명을 붙였지만 Secret은 본인의 git repo setting에서 직접 해당 Key: value를 설정해 줘야하니 참고하자</p> <p>이렇게 해두면 PR이 들어오는 것과 동시에 Github Action이 실행되고,</p> <p>TEST와 build를 실행한다.</p> <ol start="2"><li>이제는 배포의 차례이다.</li></ol> <p>배포의 단계는 2단계로 나뉜다.</p> <p>scp를 통해서 <code>Docker-compose.yml</code> Workdir로 복사해가기(Docker-compose에 대해서는 아래에서 더 자세히 설명하니 우선 넘어가자)</p> <p>ssh-action을 통해서 지정한 shell script를 실행하자.</p> <p>간단히 Yml만 확인해보고 Docker-compose에 대하여 알아보자.</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">build</span><span class="token punctuation">:</span>
  <span class="token comment"># The type of runner that the job will run on</span>
  <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest

  <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token comment"># 하위 작업에서 Docker-compose.yml 파일을 복사해오도록 하자.</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@master
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy docker<span class="token punctuation">-</span>compose via ssh password
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> appleboy/scp<span class="token punctuation">-</span>action@master
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.HOST <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.SSHKEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">source</span><span class="token punctuation">:</span> <span class="token string">'./docker-compose.yml'</span>
        <span class="token key atrule">target</span><span class="token punctuation">:</span> <span class="token string">'.'</span>

    <span class="token comment"># 하위 작없에서 nginx config를 복사해오도록 해주었다.(Optional)</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@master
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy docker<span class="token punctuation">-</span>compose via ssh password
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> appleboy/scp<span class="token punctuation">-</span>action@master
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.HOST <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.SSHKEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">source</span><span class="token punctuation">:</span> <span class="token string">'./templates/*'</span>
        <span class="token key atrule">target</span><span class="token punctuation">:</span> <span class="token string">'./templates/'</span>

    <span class="token comment"># Dokcer compose 커멘드라인을 이용해서 </span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> executing remote ssh commands using password
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> appleboy/ssh<span class="token punctuation">-</span>action@master
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.HOST <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.SSHKEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">script</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/images-tag:latest
          docker-compose down
          docker-compose up -d</span>
</code></pre></div><h2 id="docker-compose"><a href="#docker-compose" class="header-anchor">#</a> Docker-compose</h2> <p>여기서 Docker-compose에 대해서 자세히 다뤄보자.</p> <p><strong><code>Compose</code>는 다중 컨테이너 Docker 애플리케이션을 정의하고 실행하기 위한 도구이다.</strong> <code>.yml</code>확장자를 이용하여 <strong>YAML 파일을 사용하여 어플리케이션 서비스를 구성</strong>할 수 있다.</p> <p>Docker compose가 제공하는 효과적인 기능에 대하여 알아보자</p> <ul><li><strong>단일 호스트에서 여러 개의 격리된 환경 구성</strong></li> <li><strong>컨테이너 생성 시 볼륨 데이터 보존</strong></li> <li><strong>변경된 Container만 재셍성</strong></li> <li><strong>환경 간의 변수와 컴포지션 이동</strong></li></ul> <ol><li><p><strong>단일 호스트에서 여러 개의 격리된 환경 구성</strong></p> <p><code>Compose</code>는 프로젝트 이름을 사용하여 환경을 서로 독립적으로 실행한다. 여러 다른 Context에서 이프로젝트 이름을 사용할 수 잇다. <strong>예를 들어보자</strong></p> <ul><li>Dev Host에서 프로젝트의 각 기능 분기에 대해 안정적인 복사본을 실행하려는 경우처럼 하나의 환경의 여러 복사본을 만들기 위해사용할 수 있다.</li> <li>CI Server 환경에서 빌드가 서로 간섭하지 않도록 하려면 프로젝트 이름을 고유한 빌드 번호로 설정할 수 있다.</li> <li>공유 Host 또는 Dev Host 환경에서 동일한 서비스 이름을 사용할 수 있는 다른 프로젝트가 서로 간섭하는 것을 방지</li></ul></li> <li><p><strong>컨테이너 생성 시 볼륨 데이터 보존</strong></p> <p><code>Compose</code>는 서비스에서 사용하는 모든 볼륨을 보존한다. <code>docker-compose up</code>이 실행될 때 <strong>이전 실행에서 컨텡너를 찾으면 이전 컨테이너에서 새 컨테이너로 볼륨을 복사</strong>합니다.</p> <p>이 프로세스는 볼륨에서 생성한 모든 데이터가 손실되지 않도록 합니다.</p></li> <li><p><strong>변경된 Container만 재생성</strong></p> <p><code>Compose</code>는 컨테이너를 만드는 데 사용된 구성을 캐싱한다. 변경되지 않은 서비스는 다시 시작할 때 기존의 컨테이너를 재사용한다. 우린 덕분에 <strong>빠르게 환경을 구성하고 변경할 수 있다.</strong></p></li> <li><p><strong>환경 간의 변수와 컴포지션 이동</strong></p> <p><code>Compose</code>는 `Compose 파일의 변수를 지원한다. 이러한 변수를 사용함으로서 <strong>다양한 환경 또는 다른 사용자에맞는 구성을 사용자가 지정할 수 있다.</strong></p></li></ol> <p>위 내용을 간단히 이해 한다면 어떤때에 <code>Compose</code>를 구성하면 좋을지 전략을 세울수 있다.</p> <p>본론으로 들어가서 <strong>컴포저 구성</strong>은 어떻게 하였는지 함께 살펴보자</p> <p>Compose 파일에서는 <strong>Service, NetWork, Volume</strong>을 정의한다.</p> <p>파일 명세의 자세한 내용은 워낙에 방대하니 따로 다루지 않겠다.*<a href="https://docs.docker.com/compose/compose-file/compose-file-v3/" target="_blank" rel="noopener noreferrer">자세한 내용은 홈페이지를 참고<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">devserver</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> USER_NAME/IMAGE_NAME<span class="token punctuation">:</span>TAG
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> devserver
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> .
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/code
      <span class="token punctuation">-</span> /code/node_modules
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> app<span class="token punctuation">-</span>network
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 4000<span class="token punctuation">:</span><span class="token number">4000</span>

  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>mainline<span class="token punctuation">-</span>alpine
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure<span class="token punctuation">:</span><span class="token number">30</span>
    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./templates<span class="token punctuation">:</span>/etc/nginx/conf.d
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'80:80'</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> app<span class="token punctuation">-</span>network
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> devserver

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">app-network</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
</code></pre></div><p>이렇게 만들어둔 <code>docker-compose.yml</code>을 scp를 통하여 복사하고, 복사한 Compose를 <code>docker-compose up</code>을 통하여 실행한 것이다.</p> <p>현재 작성자의 환경은 Digitalocean에 Droplet을 이용한 DevServer환경임을 참고하자.</p> <p>AWS라면 NGiNX 없이 구성할 수 있지만 이런 경우에는 권한과 key관리 문제가 있을수 있으니 참고하자.</p> <p>이상으로 Docker - github action - digitaloean - nginx 를 적절히 사용하여 배포하는 node 환경 서버에 대하여 알아보았다.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Learning-things/algorism/완주하지 못한 선수.html" class="prev">
        완주하지 못한 선수
      </a></span> <span class="next"><a href="/Learning-things/go/bfs-dfs.html">
        bfs
      </a>
      →
    </span></p></div> <div></div></main></div> <footer class="siteFooter">
    © Devlog from jeong
  </footer></div><div class="global-ui"></div></div>
    <script src="/Learning-things/assets/js/app.2869015d.js" defer></script><script src="/Learning-things/assets/js/29.9734a91e.js" defer></script>
  </body>
</html>
